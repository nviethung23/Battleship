# üö¢ Ship Dock - Drag & Drop Deployment System

## Overview
Complete overhaul of the deployment phase with a professional ship dock inventory system, grid-snapped drag & drop, and real-time ghost preview with validation.

---

## ‚ú® Key Features

### A. SHIP DOCK (Left Sidebar)
**Location**: Left panel under YOU character card

**Features**:
- 5 draggable ship thumbnails with images
- Ships in order: Carrier (5) ‚Üí Battleship (4) ‚Üí Cruiser (3) ‚Üí Submarine (3) ‚Üí Destroyer (2)
- Each ship can be placed exactly once
- Placed ships become disabled (grayscale + opacity 30%)
- Visual counter: "X/5 placed"
- Reset button to return all ships to dock

**Ship Dock State**:
```javascript
{
    id: 'carrier',
    name: 'Carrier', 
    size: 5,
    label: 'T√†u s√¢n bay',
    placed: false
}
```

---

### B. GRID-SNAPPED DRAG & DROP

**Pixel-Perfect Grid System**:
- Desktop: 50px per cell ‚Üí 500x500px board
- Tablet: 45px per cell ‚Üí 450x450px board
- Mobile: 40px per cell ‚Üí 400x400px board
- Small: 32px per cell ‚Üí 320x320px board

**No Transform Scale**: Board uses fixed pixel dimensions, not `transform: scale()`

**Snap Behavior**:
1. Mouse position ‚Üí grid coordinates (row, col)
2. Ghost preview aligns to grid cell boundaries
3. Drop ‚Üí ship placed at exact grid position
4. Ship image rendered with pixel-perfect positioning

**Validation**:
```javascript
function canPlaceShipAt(shipSize, row, col, isHorizontal) {
    // Check bounds
    for (let i = 0; i < shipSize; i++) {
        const r = isHorizontal ? row : row + i;
        const c = isHorizontal ? col + i : col;
        
        if (r < 0 || r >= 10 || c < 0 || c >= 10) return false;
        if (gameState.myBoard[r][c] !== null) return false;
    }
    return true;
}
```

---

### C. GHOST PREVIEW

**Visual Feedback While Dragging**:
- Ghost ship image follows mouse
- Opacity: 0.4-0.5
- Snaps to grid cells
- Updates in real-time

**Color Coding**:
- ‚úÖ **Valid placement**: Green glow
  ```css
  filter: drop-shadow(0 0 15px rgba(40, 167, 69, 0.8))
  ```
- ‚ùå **Invalid placement**: Red glow
  ```css
  filter: drop-shadow(0 0 15px rgba(255, 87, 87, 0.8))
  ```

**Ghost Positioning**:
- Horizontal: `left = col * cellSize`, `width = size * cellSize`
- Vertical: `transform: rotate(90deg)` around center

---

### D. ROTATION SUPPORT

**Press 'R' During Drag**:
- Toggles `isHorizontal` ‚Üî `isVertical`
- Ghost preview rotates immediately
- Validation updates in real-time
- No placement required to rotate

**State Management**:
```javascript
shipDockState.isHorizontal = true; // Default
// Press R ‚Üí !isHorizontal
```

---

### E. RANDOM BUTTON BEHAVIOR

**New Logic**:
1. Only places **remaining unplaced ships** from dock
2. If some ships already placed manually ‚Üí Random fills the rest
3. All 5 ships unplaced ‚Üí Random places all

**Function**:
```javascript
function placeRemainingShipsRandomly() {
    const unplacedShips = dockShips.filter(s => !s.placed);
    unplacedShips.forEach(dockShip => {
        // Place with random position & orientation
        dockShip.placed = true;
    });
}
```

---

### F. TIMER LOCK

**When Timer Reaches 0**:
- [ ] Lock dragging from dock (ships become non-draggable)
- [ ] Disable Random button
- [ ] Disable Ready button if not all ships placed
- [ ] Optional: Auto-submit if all 5 ships placed

*(Timer lock not yet fully implemented - requires timer handler update)*

---

## üìÅ File Structure

### New Files
```
client/js/shipDock.js          - Ship dock module (420 lines)
```

### Modified Files
```
client/game.html               - Added ship dock HTML structure
client/css/game.css            - Ship dock styles + ghost preview CSS
client/js/game.js              - Integration with ship dock system
```

---

## üîß Implementation Details

### A. HTML Structure

**Ship Dock Container**:
```html
<div id="shipDock" class="ship-dock">
    <div class="dock-header">
        <h3 class="dock-title">‚öì Fleet</h3>
        <button id="resetShipsBtn" class="btn-dock-reset">‚Ü∫</button>
    </div>
    <div class="dock-ships" id="dockShips">
        <!-- Ships generated by JS -->
    </div>
    <div class="dock-footer">
        <div class="dock-counter">
            <span id="placedCount">0</span>/<span>5</span> placed
        </div>
    </div>
</div>
```

**Board Wrapper**:
```html
<div class="placement-main-area">
    <!-- Header, guide, board -->
</div>
```

---

### B. CSS Architecture

**Flex Layout**:
```css
.placement-content-center {
    display: flex;
    gap: 30px;
    align-items: flex-start;
}

.ship-dock {
    width: 200px;
    /* Glass morphism + backdrop blur */
}

.placement-main-area {
    flex: 1;
}
```

**Responsive Breakpoints**:
- `1200px`: Dock ‚Üí horizontal layout (top bar)
- `768px`: Dock ships ‚Üí 3 columns
- `480px`: Dock ships ‚Üí 2 columns

---

### C. JavaScript Modules

**shipDock.js**:
- `initShipDock(characterIndex)` - Initialize dock with character
- `renderShipDock()` - Render ship thumbnails
- `handleDockDragStart(e)` - Start drag from dock
- `handleBoardDragOver(e)` - Show ghost preview
- `handleBoardDrop(e)` - Place ship on board
- `handleDragRotation(e)` - Rotate with 'R' key
- `handleResetShips()` - Reset all ships to dock

**game.js Integration**:
```javascript
function initPlacementMode() {
    // ... init code
    
    if (window.ShipDock) {
        window.ShipDock.init(characterIndex);
    }
}
```

---

### D. Drag & Drop Flow

**1. Drag Start** (from dock):
```javascript
shipDockState.currentDrag = {
    shipId: 'carrier',
    shipName: 'Carrier',
    shipSize: 5,
    sourceElement: shipEl
};
shipEl.classList.add('dragging'); // opacity 0.5
```

**2. Drag Over** (board):
```javascript
const col = Math.floor((e.clientX - rect.left) / cellSize);
const row = Math.floor((e.clientY - rect.top) / cellSize);

const isValid = canPlaceShipAt(shipSize, row, col, isHorizontal);
showGhostPreview(row, col, isValid); // Green or red
```

**3. Drop** (board):
```javascript
if (canPlaceShipAt(...)) {
    // Place ship
    gameState.myBoard[r][c] = shipName;
    gameState.myShips.push({ name, size, cells });
    
    // Mark as placed
    dockShip.placed = true;
    
    // Update UI
    renderShipDock();
    renderPlacementBoard();
}
```

**4. Drag End**:
```javascript
shipEl.classList.remove('dragging');
removeGhostPreview();
shipDockState.currentDrag = null;
```

---

### E. Pixel-Perfect Positioning

**Horizontal Ship**:
```javascript
shipImg.style.left = `${col * cellWidth}px`;
shipImg.style.top = `${row * cellHeight}px`;
shipImg.style.width = `${size * cellWidth}px`;
shipImg.style.height = `${cellHeight}px`;
```

**Vertical Ship**:
```javascript
const centerCol = col + 0.5;
const centerRow = row + (size / 2);

shipImg.style.left = `${centerCol * cellWidth}px`;
shipImg.style.top = `${centerRow * cellHeight}px`;
shipImg.style.width = `${size * cellWidth}px`;
shipImg.style.height = `${cellHeight}px`;
shipImg.style.transform = 'translate(-50%, -50%) rotate(90deg)';
```

---

## üéÆ User Workflows

### Workflow 1: Manual Placement
1. User drags Carrier from dock
2. Hovers over board ‚Üí green ghost appears
3. Presses 'R' ‚Üí ghost rotates vertical
4. Drops ‚Üí Carrier placed, disappears from dock
5. Counter updates: "1/5 placed"
6. Repeat for remaining ships
7. When 5/5 ‚Üí Ready button enabled

### Workflow 2: Mix Manual + Random
1. User drags Carrier + Battleship manually (2/5)
2. Clicks üîÑ Random button
3. System places remaining 3 ships automatically
4. All ships marked as placed in dock
5. Ready button enabled

### Workflow 3: Full Random
1. User clicks üîÑ Random immediately
2. All 5 ships placed at once
3. Dock shows all ships as placed
4. Ready button enabled

### Workflow 4: Reset & Redo
1. User places ships incorrectly
2. Clicks ‚Ü∫ Reset button
3. All ships return to dock (enabled)
4. Board cleared
5. Counter: "0/5 placed"
6. User can place again

---

## üêõ Known Limitations

1. **Timer Lock**: Not fully implemented
   - Ships still draggable when timer = 0
   - Need to add timer event listener

2. **Ship Removal**: Cannot remove individual ships
   - Only reset all at once
   - Future: right-click to remove?

3. **Mobile Touch**: Not optimized for touch events
   - Works but could be smoother
   - Future: pointer events instead of drag events

---

## üìä State Management

**Global State**:
```javascript
gameState.myBoard[10][10]     // Cell occupation
gameState.myShips[]           // Placed ship objects
gameState.placementMode.placedShips[]  // Ship names

shipDockState.ships[]         // Dock inventory
shipDockState.currentDrag     // Active drag operation
shipDockState.ghostElement    // Ghost preview DOM element
shipDockState.isHorizontal    // Current orientation
```

**Synchronization**:
- Ship placed on board ‚Üí `dockShip.placed = true`
- Reset clicked ‚Üí Clear board + `dockShip.placed = false`
- Random ‚Üí Place ships + mark as placed

---

## üé® Visual Design

**Color Palette**:
- Dock background: `rgba(255, 255, 255, 0.08)` with backdrop blur
- Ship cards: Blue gradient `rgba(100, 149, 237, 0.3)`
- Placed ships: Grayscale 100%, opacity 0.3
- Ghost valid: Green `rgba(40, 167, 69)`
- Ghost invalid: Red `rgba(255, 87, 87)`

**Animations**:
- Dock ship hover: `translateY(-2px)` + glow
- Ghost preview: 0.1s ease transition
- Reset button: `rotate(180deg)` on hover
- Counter update: Color change animation

---

## üöÄ Future Enhancements

1. **Individual Ship Removal**: Right-click ship on board
2. **Touch Events**: Better mobile support
3. **Ship Swapping**: Drag from board to swap positions
4. **Preset Layouts**: Save/load favorite formations
5. **Animation**: Ships "fly" from dock to board
6. **Sound Effects**: Drop sound, invalid placement buzz
7. **Timer Lock**: Full implementation with warnings

---

## üìù Testing Checklist

- [x] Ship dock renders all 5 ships
- [x] Ships can be dragged from dock
- [x] Ghost preview shows on board
- [x] Ghost color changes (green/red)
- [x] Press 'R' rotates ghost
- [x] Drop places ship correctly
- [x] Ship disappears from dock when placed
- [x] Counter updates (X/5)
- [x] Ready button enables at 5/5
- [x] Random button places remaining ships
- [x] Reset button clears board
- [x] Reset re-enables all ships in dock
- [x] Ships cannot overlap
- [x] Ships stay within bounds
- [x] Pixel-perfect alignment
- [x] Responsive layout works

---

**Version**: 2.0  
**Date**: December 23, 2025  
**Status**: ‚úÖ Complete
